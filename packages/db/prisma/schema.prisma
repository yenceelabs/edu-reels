// EduReels - Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatarUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  projects      Project[]
  reels         Reel[]
  assets        Asset[]

  @@index([email])
}

// ============================================
// Project (Batch of Reels)
// ============================================

model Project {
  id                    String    @id @default(cuid())
  userId                String
  name                  String
  description           String?
  
  // Default settings for batch production
  defaultVoiceSettings  Json
  defaultAvatarSettings Json
  defaultVisualSettings Json
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reels                 Reel[]
  batchJobs             BatchJob[]

  @@index([userId])
}

// ============================================
// Reel
// ============================================

model Reel {
  id              String      @id @default(cuid())
  userId          String
  projectId       String?
  
  // Concept (Input)
  conceptTopic    String
  conceptAudience String?
  conceptKeyPoints Json?      @default("[]")
  conceptTone     String      @default("educational")
  conceptDuration Int         @default(60)
  
  // Generated Script
  script          Json?
  
  // Settings
  voiceSettings   Json
  avatarSettings  Json
  visualSettings  Json
  
  // B-Roll
  bRolls          Json        @default("[]")
  
  // Generated Assets
  voiceAudioUrl   String?
  voiceDuration   Float?
  wordTimestamps  Json?
  avatarVideoUrl  String?
  outputUrl       String?
  thumbnailUrl    String?
  
  // Status
  status          ReelStatus  @default(DRAFT)
  error           String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  project         Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)
  renderJobs      RenderJob[]

  @@index([userId])
  @@index([projectId])
  @@index([status])
}

enum ReelStatus {
  DRAFT
  GENERATING_SCRIPT
  GENERATING_VOICE
  GENERATING_AVATAR
  GENERATING_BROLL
  RENDERING
  COMPLETED
  FAILED
}

// ============================================
// Asset
// ============================================

model Asset {
  id          String      @id @default(cuid())
  userId      String
  type        AssetType
  filename    String
  url         String
  thumbnail   String?
  duration    Float?
  createdAt   DateTime    @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
}

enum AssetType {
  VIDEO
  AUDIO
  IMAGE
  AVATAR
}

// ============================================
// Render Job
// ============================================

model RenderJob {
  id            String        @id @default(cuid())
  reelId        String
  status        RenderStatus  @default(QUEUED)
  progress      Int           @default(0)
  currentStep   String?
  outputUrl     String?
  error         String?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime      @default(now())

  reel          Reel          @relation(fields: [reelId], references: [id], onDelete: Cascade)

  @@index([reelId])
  @@index([status])
}

enum RenderStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// Batch Job
// ============================================

model BatchJob {
  id            String      @id @default(cuid())
  projectId     String
  reelIds       Json        @default("[]")
  status        BatchStatus @default(QUEUED)
  progress      Int         @default(0)
  completedCount Int        @default(0)
  failedCount   Int         @default(0)
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime    @default(now())

  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
}

enum BatchStatus {
  QUEUED
  PROCESSING
  COMPLETED
  PARTIAL
  FAILED
}
